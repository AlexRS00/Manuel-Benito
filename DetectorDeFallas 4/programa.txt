using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Net.Mail;
using System.Threading;
using System.IO.Ports;

namespace DetectorDeFallas
{
    public partial class Form1 : Form
    {
        public Form1()
        {
            InitializeComponent();
        }

        private void comboBox1_SelectedIndexChanged(object sender, EventArgs e)
        {
            Boton1.Enabled = true; //habilita el boton de abrir puerto
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            //busca todos los nombres de puertos disponibles
            foreach (string s in SerialPort.GetPortNames())
            {
                comboBox1.Items.Add(s); //Agrega cada nombre de puerto al comboBox
            }
            ControlBox = false; //Elimina los botones de minimizar, maximizar y cerrar
        }

        private void Boton1_Click(object sender, EventArgs e)
        {
            if (serialPort1.IsOpen)
            {
                serialPort1.Close();                //cierra el puerto serial
                label4.Text = "Cerrado";            //cambia el texto
                Boton1.Text = "Abrir puerto";       //cambia el texto
                timer1.Enabled = false;             //deshabilita los timers
                timer2.Enabled = false;
                timer3.Enabled = false;
                timer4.Enabled = false;
                timer5.Enabled = false;
                TimerFailFail.Enabled = false;
                TimerSwitchFail.Enabled = false;
                TimerPassFail.Enabled = false;
                BotonDeColor.BackColor = Color.Red; //cambia el color a rojo
            }
            else
            {
                serialPort1.PortName = comboBox1.Text;
                serialPort1.Open();                          //abre el puerto serial
                label4.Text = "Abierto";                     //cambia el texto
                Boton1.Text = "Puerto abierto";              //cambia el texto
                BotonDeColor.BackColor = Color.ForestGreen;  //cambia el color
                timer5.Enabled = true;              //habilita el timer
                Boton1.Enabled = false;            //bloquea el boton de abrir puerto
                comboBox1.Enabled = false;         //bloquea el ComboBox
            }
        }

        //declaración de variables
        string P0, P1, P2, P3, P4, P5;
        double Pass, Fail, Switch, PassControl, FailControl, SwitchControl;
        int a, b, c;
        int x;
        int m, n, o;

        //declaracion de variables para correo electronico
        const string usuario = "alex.rosales@uttn.mx";

        const string password = "Alexzael00";
        string txtDe = "alex.rosales@uttn.mx";
        string txtAsunto = "Falla de Tester en Celda 16";
        string txtPara = "alexrosales2k@outlook.com, alex.rosales@uttn.mx";



        private static void EnviarCorreo(StringBuilder Mensaje, DateTime FechaDeEnvio, string De, string Para, string Asunto, out string Error)
        {
            Error = "";
            try
            {

                Mensaje.Append(Environment.NewLine);
                Mensaje.Append(string.Format("Este correo ha sido enviado el día {0:dd/MM/yyyy} a las {0:HH:mm:ss} Hrs: \n\n", FechaDeEnvio));
                Mensaje.Append(Environment.NewLine);
                MailMessage mail = new MailMessage();
                mail.From = new MailAddress(De);
                mail.To.Add(Para);
                mail.Subject = Asunto;
                mail.Body = Mensaje.ToString();
                SmtpClient smtp = new SmtpClient("smtp.outlook.com");
                smtp.Port = 587;
                smtp.UseDefaultCredentials = false;
                smtp.Credentials = new System.Net.NetworkCredential(usuario, password);
                smtp.EnableSsl = true;
                smtp.Send(mail);
                Error = "Correo enviado";
                MessageBox.Show(Error);
            }


            catch (Exception ex)
            {
                Error = "Error: " + ex.Message;
                throw;
                return;
            }
        }

        private void timer1_Tick(object sender, EventArgs e)
        {
            for (a = 0; a <= 5100; a++)

            {
                if (a >= 5100)
                {
                    TimerFailFail.Enabled = false;
                    timer1.Enabled = false;
                }
            }
        }

        private void timer2_Tick(object sender, EventArgs e)
        {
            //cuenta cada segundo
            for (b = 0; b <= 5100; b++)

            {
                if (b >= 5100)
                {
                    TimerSwitchFail.Enabled = false;
                    timer2.Enabled = false;
                }
            }
        }
        private void timer3_Tick(object sender, EventArgs e)
        {
            //cuenta cada segundo
            for (c = 0; c <= 5100; c++)

            {
                if (c >= 5100)
                {
                    TimerPassFail.Enabled = false;
                    timer3.Enabled = false;
                }
            }

        }
        private void timer4_Tick(object sender, EventArgs e)
        {
            Reporte_de_solución.Form1 p1 = new Reporte_de_solución.Form1();
            p1.Show();

            timer4.Enabled = false;
        }

        private void timer5_Tick(object sender, EventArgs e)
        {
            string ErrorPort;
            try
            {

                serialPort1.Write("5");
                P0 = serialPort1.ReadLine();
                Pass = 5 * Convert.ToDouble(P0) / 1023;

                serialPort1.Write("4");
                P1 = serialPort1.ReadLine();
                Fail = 5 * Convert.ToDouble(P1) / 1023;

                serialPort1.Write("3");
                P2 = serialPort1.ReadLine();
                Switch = 5 * Convert.ToDouble(P2) / 1023;

                serialPort1.Write("2");
                P3 = serialPort1.ReadLine();
                PassControl = 5 * Convert.ToDouble(P3) / 1023;

                serialPort1.Write("1");
                P4 = serialPort1.ReadLine();
                FailControl = 5 * Convert.ToDouble(P4) / 1023;

                serialPort1.Write("0");
                P5 = serialPort1.ReadLine();
                SwitchControl = 5 * Convert.ToDouble(P5) / 1023;

                int deteccion = x;

                if (SwitchControl < 1 & PassControl < 1 & FailControl < 1)
                {
                    x = 0;
                }
                if (SwitchControl > 1)
                {
                    x = 1;
                }
                if (PassControl > 1)
                {
                    x = 2;
                }
                if (FailControl > 1)
                {
                    x = 3;
                }

                label6.Text = deteccion.ToString();
                switch (deteccion)
                {
                    case 0:
                        timer1.Enabled = false;
                        timer2.Enabled = false;
                        timer3.Enabled = false;
                        TimerSwitchFail.Enabled = false;
                        TimerFailFail.Enabled = false;
                        TimerPassFail.Enabled = false;
                        break;

                    case 1:
                        if (Switch > 1)
                        {
                            //TODO BIEN
                            timer2.Enabled = false;
                            TimerSwitchFail.Enabled = false;

                        }
                        if (Switch < 1)
                        {
                            //FALLA
                            timer2.Enabled = true;
                            TimerSwitchFail.Enabled = true;
                            if (b >= 5100)
                            {
                                timer2.Enabled = false;
                                TimerSwitchFail.Enabled = false;
                            }
                        }
                        if (b >= 5100)
                        {
                            if (Switch > 1)
                            {
                                timer4.Enabled = true;
                                b = 0;
                            }
                        }
                        break;

                    case 2:
                        if (Pass > 1)
                        {
                            //TODO BIEN
                            timer3.Enabled = false;
                            TimerPassFail.Enabled = false;
                        }
                        if (Pass < 1)
                        {
                            timer3.Enabled = true;
                            TimerPassFail.Enabled = true;
                            if (c >= 5100)
                            {
                                timer3.Enabled = false;
                                TimerPassFail.Enabled = false;
                            }
                        }
                        if (c >= 5100)
                        {
                            if (Pass > 1)
                            {
                                timer4.Enabled = true;
                                c = 0;
                            }
                        }
                        break;

                    case 3:
                        if (Fail > 1)
                        {
                            //TODO BIEN
                            timer1.Enabled = false;
                            TimerFailFail.Enabled = false;
                        }
                        if (Fail < 1)
                        {
                            timer1.Enabled = true;
                            TimerFailFail.Enabled = true;
                            if (a >= 5100)
                            {
                                timer1.Enabled = false;
                                TimerFailFail.Enabled = false;
                            }
                        }
                        if (a >= 5100)
                        {
                            if (Fail > 1)
                            {
                                timer4.Enabled = true;
                                a = 0;
                            }
                        }
                        break;
                    default:
                        //no pasa nada
                        break;
                }
                    
            }
            catch (Exception Error)
            {
                ErrorPort = "Error: " + Error.Message;
                return;
            }

        }


        private void TimerFailFail_Tick_1(object sender, EventArgs e)
        {
            string Error = "";
            StringBuilder MensajeBuilder = new StringBuilder();
            MensajeBuilder.Append("Falla en lampara Fail, celda 16".Trim());
            EnviarCorreo(MensajeBuilder, DateTime.Now, txtDe.Trim(), txtPara.Trim(), txtAsunto.Trim(), out Error);
        }
        private void TimerSwitchFail_Tick(object sender, EventArgs e)
        {
            string Error = "";
            StringBuilder MensajeBuilder = new StringBuilder();
            MensajeBuilder.Append("Falla en lampara Switch, celda 16".Trim());
            EnviarCorreo(MensajeBuilder, DateTime.Now, txtDe.Trim(), txtPara.Trim(), txtAsunto.Trim(), out Error);
        }

        private void TimerPassFail_Tick(object sender, EventArgs e)
        {
            string Error = "";
            StringBuilder MensajeBuilder = new StringBuilder();
            MensajeBuilder.Append("Falla en lampara Pass, celda 16".Trim());
            EnviarCorreo(MensajeBuilder, DateTime.Now, txtDe.Trim(), txtPara.Trim(), txtAsunto.Trim(), out Error);
        }

        private void Boton2_Click(object sender, EventArgs e)
        {
            Inicio_de_sesión.Form1 p2 = new Inicio_de_sesión.Form1();
            p2.Show();
        }

        private void BotonExit_Click(object sender, EventArgs e)
        {
            //declaracion de variables
            DialogResult resultado;      //variable para almacenar el valor regresado por messagebox

            resultado = MessageBox.Show("¿Estás seguro que deseas salir?", "¿SALIR?", MessageBoxButtons.OKCancel, MessageBoxIcon.Question);

            if (resultado == DialogResult.OK)   //verifica si se presionó el boton OK
                this.Close();                   //cierra el forms1 (this)
        }

    }
}
